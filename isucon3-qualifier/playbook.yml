- hosts: all
  become: yes
  tasks:
    - yum: name=* state=latest
    - yum: name=libselinux-python
    - yum: name=epel-release
    - yum: name=git
    - yum: name=patch

    # SELinux
    - selinux: state=disabled

    # memcached
    - yum: name=memcached
    - copy: src=files/etc/sysconfig/memcached dest=/etc/sysconfig/
    - service: name=memcached enabled=yes state=started

    # httpd
    - yum: name=httpd
    - yum: name=php
    - yum: name=php-mysql
    - yum: name=php-pecl-memcached
    - yum: name=php-pecl-igbinary
    - yum: name=php-xml
    - copy: src=files/etc/httpd/conf.d/isucon.conf dest=/etc/httpd/conf.d/
    - service: name=httpd enabled=yes state=started

    # user isucon
    - user: name=isucon
    - copy: src=files/home/isucon/env.sh dest=/home/isucon/ owner=isucon group=isucon mode=a+x
    - copy: src=files/etc/sudoers.d/isucon dest=/etc/sudoers.d/

    - git: repo=https://github.com/kayac/isucon3.git dest=/tmp/isucon3
    - shell: |
        set -e
        rsync -a /tmp/isucon3/qualifier/ /home/isucon/
        chown -R isucon:isucon /home/isucon/

    # mysql
    - yum: name=https://dev.mysql.com/get/mysql80-community-release-el6-3.noarch.rpm
    - shell: |
        yum-config-manager --disable mysql80-community
        yum-config-manager --enable mysql56-community
    - yum: name=mysql-community-server update_cache=yes
    - yum: name=mysql-community-devel
    - yum: name=mysql-community-embedded
    - service: name=mysqld enabled=yes state=started
    - file: path=/opt/isucon/bin state=directory owner=isucon
    - file: path=/opt/isucon/data state=directory owner=isucon
    - copy: src=files/opt/isucon/data/init.sql.gz dest=/opt/isucon/data/
    - shell: |
        set -e
        ( echo ; echo Y ; echo root ; echo root ; echo Y ; echo Y ; echo Y ; echo Y ) | mysql_secure_installation
        mysqladmin -proot create isucon
        mysqladmin -proot create test
        echo "GRANT ALL ON isucon.* TO isucon@'%'" | mysql -proot
        gzip -dc /opt/isucon/data/init.sql.gz | mysql -proot isucon
        cat /usr/share/mysql/innodb_memcached_config.sql | mysql -proot
        echo "install plugin daemon_memcached soname \"libmemcached.so\"" | mysql -proot
        echo "[mysqld]" > /usr/my.cnf
      args:
        creates: /usr/my.cnf
      notify: restart mysqld
    - file: path=/etc/my.cnf state=absent

    # xbuild
    - yum: name=gcc
    - become_user: isucon
      git: repo=https://github.com/tagomoris/xbuild.git dest=/home/isucon/.xbuild

    # go
    - become_user: isucon
      shell: .xbuild/go-install 1.9 /home/isucon/local/go
      args:
        chdir: /home/isucon/
        creates: /home/isucon/local/go/bin/go
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd webapp/go/
        go get github.com/go-sql-driver/mysql
        go get github.com/gorilla/mux
        go get github.com/gorilla/sessions
        go get github.com/gorilla/context
        go get github.com/bradfitz/gomemcache/memcache
        go build -o app
      args:
        chdir: /home/isucon/
        creates: /home/isucon/webapp/go/app

    # nodejs
    - become_user: isucon
      shell: .xbuild/node-install v0.10.20 /home/isucon/local/node-v0.10
      args:
        chdir: /home/isucon/
        creates: /home/isucon/local/node-v0.10/bin/node
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd webapp/nodejs/
        npm config set strict-ssl false
        npm install
        npm config set strict-ssl true
      args:
        chdir: /home/isucon/
        creates: /home/isucon/webapp/nodejs/node_modules

    # perl
    - become_user: isucon
      shell: .xbuild/perl-install 5.18.1 /home/isucon/local/perl-5.18
      args:
        chdir: /home/isucon/
        creates: /home/isucon/local/perl-5.18/bin/perl
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd webapp/perl/
        curl -L https://cpanmin.us | perl - Carton
        carton install
      args:
        chdir: /home/isucon/

    # ruby
    - yum: name=openssl-devel
    - yum: name=readline-devel
    - yum: name=zlib-devel
    - become_user: isucon
      #shell: .xbuild/ruby-install 2.0.0-p247 /home/isucon/local/ruby-2.0
      shell: .xbuild/ruby-install 2.0.0-p645 /home/isucon/local/ruby-2.0
      args:
        chdir: /home/isucon/
        creates: /home/isucon/local/ruby-2.0/bin/ruby
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd webapp/ruby/
        gem install bundler -v 1.17.3
        gem install foreman
        bundle install --deployment --without development
      args:
        chdir: /home/isucon/

    # python
    - yum: name=patch
    - become_user: isucon
      shell: .xbuild/python-install 3.3.2 /home/isucon/local/python-3.3
      args:
        chdir: /home/isucon/
        creates: /home/isucon/local/python-3.3/bin/python
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd webapp/python/
        pip3 install --upgrade flask gunicorn python3-memcached PyMySQL==0.8.0 Werkzeug==0.14.1 click==6.7 itsdangerous==0.24 MarkupSafe==1.0
      args:
        chdir: /home/isucon/

    # bench
    - yum: name=pigz
    - yum: name=libxml2-devel
    - become_user: isucon
      shell: |
        set -e
        source ./env.sh
        cd qualifier_bench
        go get github.com/moovweb/gokogiri
        go get github.com/wsxiaoys/terminal
        go build
      args:
        chdir: /home/isucon/

    # supervisor package is too old
    # - yum: name=supervisor
    - yum: name=python-pip
    - pip: name=supervisor version=3.4.0
    - pip: name=meld3 version=1.0.0 state=forcereinstall
    - copy: src=files/etc/init.d/supervisord dest=/etc/init.d/ mode=a+x
    - copy: src=files/etc/sysconfig/supervisord dest=/etc/sysconfig/
    - copy: src=files/etc/supervisord.conf dest=/etc/
    - shell: /sbin/chkconfig --add supervisord
    - service: name=supervisord enabled=yes state=started

    # cleanup
    - file: path=/home/isucon/.xbuild state=absent
    - file: path=/tmp/isucon3 state=absent
    - file: path=/var/log/mysqld.log state=absent
    - file: path=/var/log/yum.log state=absent
    - shell: |
        rm -f /tmp/*-build*
        rm -f /tmp/python-*
        rm -f /tmp/isucon*
        rm -f /tmp/yum*

  handlers:
    - name: restart mysqld
      service: name=mysqld state=restarted
